/*! Fabrik */

FabrikAdmin.model.fields.fabriktable=FabrikAdmin.model.fields.fabriktable||{},FabrikAdmin.model.cache=FabrikAdmin.model.cache||{},FabrikAdmin.model.cache.fabriktable=FabrikAdmin.model.cache.fabriktable||{};var fabriktablesElement=new Class({Implements:[Options,Events],options:{conn:null,connInRepeat:!0},initialize:function(e,t){this.el=document.id(e),this.setOptions(t),this.elements=[],this.elementLists=$H({}),this.waitingElements=$H({}),"null"===typeOf(document.id(this.options.conn))?this.periodical=this.getCnn.periodical(500,this):this.setUp()},getCnn:function(){"null"!==typeOf(document.id(this.options.conn))&&(this.setUp(),clearInterval(this.periodical))},registerElement:function(e){this.elements.push(e),this.updateElements()},setUp:function(){if(this.cnn=document.id(this.options.conn),"null"!==this.cnn){this.loader=document.id(this.el.id+"_loader"),this.cnn.hasClass("chzn-done")&&jQuery("#"+this.cnn.id).on("change",function(e){document.id(this.cnn).fireEvent("change",new Event.Mock(document.id(this.cnn),"change"))}.bind(this)),this.cnn.addEvent("change",function(e){this.updateMe(e)}.bind(this)),this.el.hasClass("chzn-done")&&jQuery("#"+this.el.id).on("change",function(e){document.id(self.el.id).fireEvent("change",new Event.Mock(document.id(self.el.id),"change"))}),this.el.addEvent("change",function(e){this.updateElements(e)}.bind(this));var e=this.cnn.get("value");""!==e&&-1!==e&&this.updateMe()}},updateMe:function(e){e&&e.stop();var i=this.cnn.get("value");if(i)if(FabrikAdmin.model.cache.fabriktable[i])this.updateMeSelect(FabrikAdmin.model.cache.fabriktable[i]);else{this.loader&&this.loader.show();var t=new Request({url:"index.php",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",g:"element",plugin:"field",method:"ajax_tables",showf:"1",cid:i.toInt()},onSuccess:function(e){var t=JSON.parse(e);"null"!==typeOf(t)&&(t.err?alert(t.err):(FabrikAdmin.model.cache.fabriktable[i]=t,this.updateMeSelect(t),this.loader&&this.loader.hide()))}.bind(this),onFailure:function(e){console.log("fabriktables request failure",e.getResponseHeader("Status"))}.bind(this),onException:function(e,t){console.log("fabriktables request exception",e,t)}.bind(this)});Fabrik.requestQueue.add(t)}},updateMeSelect:function(e){this.el.empty(),e.each(function(e){var t={value:e.id};e.id===this.options.value&&(t.selected="selected"),new Element("option",t).appendText(e.label).inject(this.el)}.bind(this)),this.el.hasClass("chzn-done")&&jQuery("#"+this.el.id).trigger("liszt:updated"),this.updateElements()},updateElements:function(){this.elements.each(function(e){var t=e.getOpts(),i=this.el.get("value");if(""!==i){this.loader&&this.loader.show();var n=t.getValues().toString()+","+i;if(this.waitingElements.has(n)||(this.waitingElements[n]=$H({})),void 0!==this.elementLists[n])""===this.elementLists[n]?this.waitingElements[n][e.el.id]=e:this.updateElementOptions(this.elementLists[n],e);else{var s=this.cnn.get("value");this.elementLists.set(n,"");var a={option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",g:"element",plugin:"field",method:"ajax_fields",cid:s.toInt(),showf:"1",k:"2",t:i};t.each(function(e,t){a[t]=e}),new Request({url:"index.php",data:a,onComplete:function(i){this.elementLists.set(n,i),this.updateElementOptions(i,e),this.waitingElements.get(n).each(function(e,t){this.updateElementOptions(i,e),this.waitingElements[n].erase(t)}.bind(this))}.bind(this),onFailure:function(e){this.waitingElements.get(n).each(function(e,t){this.updateElementOptions("[]",e),this.waitingElements[n].erase(t)}.bind(this)),this.loader&&this.loader.hide(),alert(e.status+": "+e.statusText)}.bind(this)}).send()}}}.bind(this))},updateElementOptions:function(r,element){var target,dotValue;if(""!==r){var table=document.id(this.el).get("value"),key=element.getOpts().getValues().toString()+","+table,opts=eval(r);target="textarea"===element.el.get("tag")?element.el.getParent().getElement("select"):element.el,target.empty();var o={value:""};""===element.options.value&&(o.selected="selected"),new Element("option",o).appendText("-").inject(target),dotValue=element.options.value.replace(".","___"),opts.each(function(e){var t=e.value.replace("[]",""),i={value:t};t!==element.options.value&&t!==dotValue||(i.selected="selected"),new Element("option",i).set("text",e.label).inject(target)}.bind(this)),this.loader&&this.loader.hide()}},cloned:function(e,t){if(!0===this.options.connInRepeat){var i="-"+t.toString(),n=t.toString()+"__";if(-1!==e.indexOf(n))this.options.conn=this.options.conn.replace("X__",n);else if(e.slice(-i.length)===i){var s=this.options.conn.split("-");s.pop(),this.options.conn=s.join("-")+i}}document.id(e).getParent().getElement("img").id=e+"_loader",this.el=document.id(e),this.elements=[],this.elementLists=$H({}),this.waitingElements=$H({}),this.setUp(),FabrikAdmin.model.fields.fabriktable[this.el.id]=this}});