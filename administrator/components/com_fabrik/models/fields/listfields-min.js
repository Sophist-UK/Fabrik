/*! Fabrik */

var ListFieldsElement=new Class({Implements:[Options,Events],addWatched:!1,options:{conn:null,highlightpk:!1,showAll:1,mode:"dropdown",defaultOpts:[],addBrackets:!1},initialize:function(e,t){var n,s;if(this.strEl=e,this.el=e,this.setOptions(t),0<this.options.defaultOpts.length){this.el=document.id(this.el),"gui"===this.options.mode?(this.select=this.el.getParent().getElement("select.elements"),s=[this.select],"null"===typeOf(document.id(this.options.conn))&&this.watchAdd()):(s=document.getElementsByName(this.el.name),this.el.empty(),document.id(this.strEl).empty());var i=this.options.defaultOpts;Array.each(s,function(e){document.id(e).empty()}),i.each(function(t){var i={value:t.value};t.value===this.options.value&&(i.selected="selected"),Array.each(s,function(e){n=t.label?t.label:t.text,new Element("option",i).set("text",n).inject(e)})}.bind(this))}else"null"===typeOf(document.id(this.options.conn))?this.cnnperiodical=this.getCnn.periodical(100,this):this.setUp()},cloned:function(e,t){this.strEl=e,this.el=document.id(e),this._cloneProp("conn",t),this._cloneProp("table",t),this.setUp()},_cloneProp:function(e,t){var i=this.options[e].split("-");(i=i.splice(0,i.length-1)).push(t),this.options[e]=i.join("-")},getCnn:function(){"null"!==typeOf(document.id(this.options.conn))&&(this.setUp(),clearInterval(this.cnnperiodical))},setUp:function(){if(this.el=document.id(this.el),"gui"===this.options.mode){this.select=this.el.getParent().getElement("select.elements");var e=this.el.value.length;this.setSelection(this.el,e,e)}document.id(this.options.conn).addEvent("change",function(){this.updateMe()}.bind(this)),document.id(this.options.table).addEvent("change",function(){this.updateMe()}.bind(this));var t=document.id(this.options.conn).get("value");""!==t&&-1!==t&&(this.periodical=this.updateMe.periodical(100,this)),e=this.el.value.length,this.setSelection(this.el,e,e),this.watchAdd()},watchAdd:function(){if(!0!==this.addWatched){this.addWatched=!0;var e=this.el.getParent().getElement("button");"null"!==typeOf(e)&&(e.addEvent("mousedown",function(e){e.stop(),this.addPlaceHolder()}.bind(this)),e.addEvent("click",function(e){e.stop()}))}},updateMe:function(e){"event"===typeOf(e)&&e.stop(),document.id(this.el.id+"_loader")&&document.id(this.el.id+"_loader").show();var conn=document.id(this.options.conn);if(conn){var cid=document.id(this.options.conn).get("value"),tid=document.id(this.options.table).get("value");if(tid){clearInterval(this.periodical);var url="index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&g=element&plugin=field&method=ajax_fields&showall="+this.options.showAll+"&cid="+cid+"&t="+tid,myAjax=new Request({url:url,method:"get",data:{highlightpk:this.options.highlightpk,k:2},onComplete:function(r){var els;"null"!==typeOf(document.id(this.strEl))&&(this.el=document.id(this.strEl)),"gui"===this.options.mode?els=[this.select]:(els=document.getElementsByName(this.el.name),this.el.empty(),document.id(this.strEl).empty());var opts=eval(r);Array.each(els,function(e){document.id(e).empty()}),opts.each(function(t){var i={value:t.value};t.value===this.options.value&&(i.selected="selected"),Array.each(els,function(e){new Element("option",i).set("text",t.label).inject(e)})}.bind(this)),document.id(this.el.id+"_loader")&&document.id(this.el.id+"_loader").hide()}.bind(this)});Fabrik.requestQueue.add(myAjax)}}else clearInterval(this.periodical)},addPlaceHolder:function(){var e=this.el.getParent().getElement("select").get("value");this.options.addBrackets&&(e="{"+(e=e.replace(/\./,"___"))+"}"),this.insertTextAtCaret(this.el,e)},getInputSelection:function(e){var t,i,n,s,o,l=0,a=0;return"number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd?(l=e.selectionStart,a=e.selectionEnd):(i=document.selection.createRange())&&i.parentElement()===e&&(s=e.value.length,t=e.value.replace(/\r\n/g,"\n"),(n=e.createTextRange()).moveToBookmark(i.getBookmark()),(o=e.createTextRange()).collapse(!1),-1<n.compareEndPoints("StartToEnd",o)?l=a=s:(l=-n.moveStart("character",-s),l+=t.slice(0,l).split("\n").length-1,-1<n.compareEndPoints("EndToEnd",o)?a=s:(a=-n.moveEnd("character",-s),a+=t.slice(0,a).split("\n").length-1))),{start:l,end:a}},offsetToRangeCharacterMove:function(e,t){return t-(e.value.slice(0,t).split("\r\n").length-1)},setSelection:function(e,t,i){if("number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd)e.selectionStart=t,e.selectionEnd=i;else if(void 0!==e.createTextRange){var n=e.createTextRange(),s=this.offsetToRangeCharacterMove(e,t);n.collapse(!0),t===i?n.move("character",s):(n.moveEnd("character",this.offsetToRangeCharacterMove(e,i)),n.moveStart("character",s)),n.select()}},insertTextAtCaret:function(e,t){var i=this.getInputSelection(e).end,n=e.value;0!==i&&" "!==n.substring(i-1,1)&&(t=" "+t),i!==n.length&&" "!==n.substring(i,1)&&(t+=" ");var s=i+t.length;n=e.value,e.value=n.slice(0,i)+t+n.slice(i),this.setSelection(e,s,s)}});