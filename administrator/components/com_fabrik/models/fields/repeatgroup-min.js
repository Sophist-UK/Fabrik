/*! Fabrik */

var FbRepeatGroup=new Class({Implements:[Options,Events],options:{repeatmin:1},initialize:function(e,t){this.element=document.id(e),this.setOptions(t),this.counter=this.getCounter(),this.watchAdd(),this.watchDelete()},repeatContainers:function(){return this.element.getElements(".repeatGroup")},watchAdd:function(){this.element.getElement("a[data-button=addButton]").addEvent("click",function(e){e.stop();var t=this.repeatContainers().getLast(),n=t.id.replace("-"+(this.counter-1),"-"+this.counter),o=new Element("div",{class:"repeatGroup",id:n}).set("html",t.innerHTML);if(o.inject(t,"after"),0!==this.counter){var a=new Event("change");o.getElements("input, select, textarea, label, button").each(function(e){if("select"==e.get("tag")){var t=e.getElement("option");t&&(e.set("value",t.get("value")),e.dispatchEvent(a))}if(""!==e.id){var i=e.id;newId=this._incrementId(e),o.getElements('[for="'+i+'"]').each(function(e){e.set("for",newId)}),e.name&&(e.name=this._incrementName(e.name)),$H(FabrikAdmin.model.fields).each(function(e,t){var n=!1;"null"!==typeOf(FabrikAdmin.model.fields[t][i])&&!1!==(n=Object.clone(FabrikAdmin.model.fields[t][i]))&&(n.cloned(newId,this.counter),FabrikAdmin.model.fields[t][newId]=n)}.bind(this))}}.bind(this)),o.getElements("img[src=components/com_fabrik/images/ajax-loader.gif]").each(function(e){e.id&&(e.id=this._incrementId(e))}.bind(this)),this._incrementShowon(o),FabrikAdmin.reTip(),document.dispatchEvent(new CustomEvent("fabrikadmin.repeatgroup.add",{detail:o}))}this.counter++}.bind(this))},getCounter:function(){return this.repeatContainers().length},watchDelete:function(){this.element.getElements("a[data-button=deleteButton]").removeEvents(),this.element.getElements("a[data-button=deleteButton]").each(function(e,t){e.addEvent("click",function(e){if(e.stop(),!(this.getCounter()<=this.options.repeatmin)){var t=this.repeatContainers().getLast();document.dispatchEvent(new CustomEvent("fabrikadmin.repeatgroup.remove",{detail:t})),t.destroy(),this.counter--}}.bind(this))}.bind(this))},_incrementId:function(e){var t=e.id,n=this.counter,i=n-1;return 0<=t.indexOf(i+"__")?t=e.id=t.replace(i+"__",n+"__"):0<=t.indexOf("-"+i)&&(t=e.id=t.replace("-"+i,"-"+n)),t},_incrementName:function(e){var t=e.split("]["),n=t[2].replace("]","").toInt();return n++,3===t.length&&(n+="]"),t.splice(2,1,n),t.join("][")},_incrementShowon:function(e){e.getElements("div[data-showon]").each(function(e){var t=e.getProperty("data-showon");try{t=JSON.parse(t)}catch(e){return void fconsole("Fabrik repeatgroup: Showon incorrect format:",t)}if(Array.isArray(t)){for(var n=0;n<t.length;n++)t[n].hasOwnProperty("field")&&(t[n].field=this._incrementName(t[n].field));e.setAttribute("data-showon",JSON.stringify(t))}else fconsole("Fabrik repeatgroup: Showon not array:",t)}.bind(this)),"function"==typeof Joomla.setUpShowon&&Joomla.setUpShowon(e)}});